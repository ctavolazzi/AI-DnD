<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎭 The Narrative Theater 🎲 - Simple Version</title>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas for capturing page content -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(90deg, #8B4513 0%, #A0522D 50%, #8B4513 100%);
            color: #2c1810;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 25px;
            background: linear-gradient(180deg, #d2691e 0%, #8B4513 100%);
            border: 4px solid #3e2723;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 42px;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
        }

        .subtitle {
            color: #ffecb3;
            font-size: 16px;
            margin-top: 10px;
        }

        .start-screen {
            text-align: center;
            padding: 60px 20px;
            background: rgba(210, 105, 30, 0.3);
            border: 3px solid #3e2723;
            border-radius: 8px;
        }

        .start-screen h2 {
            font-size: 32px;
            color: #3e2723;
            margin-bottom: 20px;
        }

        .start-screen p {
            font-size: 18px;
            color: #5d4037;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .controls {
            background: rgba(255,236,179,0.6);
            border: 2px solid #8B4513;
            border-radius: 6px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #3e2723;
        }

        select, input {
            width: 100%;
            padding: 10px;
            border: 2px solid #8B4513;
            border-radius: 4px;
            background: white;
            font-size: 16px;
            margin-bottom: 15px;
        }

        button {
            background: #8B4513;
            color: #ffd700;
            border: 2px solid #3e2723;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-weight: bold;
            width: 100%;
        }

        button:hover {
            background: #A0522D;
            transform: scale(1.02);
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border: 2px solid #3e2723;
            border-radius: 6px;
            text-align: left;
        }

        .hidden {
            display: none;
        }

        .story-content {
            background: rgba(255,236,179,0.6);
            border: 2px solid #8B4513;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
        }

        /* Markdown Styling */
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            color: #3e2723;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .markdown-content h1 {
            font-size: 28px;
            border-bottom: 3px solid #8B4513;
            padding-bottom: 10px;
        }

        .markdown-content h2 {
            font-size: 24px;
            border-bottom: 2px solid #A0522D;
            padding-bottom: 8px;
        }

        .markdown-content h3 {
            font-size: 20px;
            color: #5d4037;
        }

        .markdown-content p {
            margin: 15px 0;
            line-height: 1.8;
        }

        .markdown-content strong {
            color: #3e2723;
            font-weight: bold;
        }

        .markdown-content em {
            color: #5d4037;
            font-style: italic;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        .markdown-content li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .markdown-content blockquote {
            border-left: 4px solid #8B4513;
            padding-left: 20px;
            margin: 15px 0;
            font-style: italic;
            color: #5d4037;
            background: rgba(139, 69, 19, 0.1);
            padding: 15px 20px;
            border-radius: 4px;
        }

        .markdown-content code {
            background: rgba(62, 39, 35, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .markdown-content pre {
            background: rgba(62, 39, 35, 0.1);
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 15px 0;
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
        }

        .markdown-content hr {
            border: none;
            border-top: 2px solid #8B4513;
            margin: 25px 0;
        }

        .markdown-content a {
            color: #8B4513;
            text-decoration: underline;
        }

        .markdown-content a:hover {
            color: #A0522D;
        }

        /* Loading Animation */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #8B4513;
            border-top: 4px solid #F5DEB3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-text {
            color: #F5DEB3;
            font-size: 24px;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">✨ Generating your adventure artwork...</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>🎭 THE NARRATIVE THEATER 🎲</h1>
            <div class="subtitle">Where Stories Come Alive • AI-Powered D&D Adventures</div>
        </div>

        <div id="start-screen" class="start-screen">
            <h2>Welcome, Adventurer!</h2>
            <p>
                Embark on an epic journey where narrative and imagery merge.<br>
                Your choices shape the story, and every moment can be visualized.<br>
                The theater awaits...
            </p>

            <div class="controls">
                <label for="modelSelect">🤖 AI Model:</label>
                <select id="modelSelect">
                    <option value="gemini">Gemini 2.5 Flash (Recommended)</option>
                    <option value="ollama">Ollama (Local)</option>
                </select>

                <label for="characterName">⚔️ Your Character Name:</label>
                <input type="text" id="characterName" placeholder="Enter your hero's name..." value="Thorin">

                <button onclick="startAdventure()">🎲 Start Your Adventure</button>
            </div>

            <div id="start-status" class="status hidden">
                <h3>Status:</h3>
                <div id="status-content">Ready to begin...</div>
            </div>
        </div>

        <div id="story-screen" class="story-content hidden">
            <h2>📖 Your Adventure</h2>

            <!-- Image container for generated artwork -->
            <div id="scene-image-container" class="hidden" style="text-align: center; margin: 20px 0;">
                <img id="scene-image" style="max-width: 100%; border-radius: 10px; border: 3px solid #8B4513;" alt="Scene artwork">
            </div>

            <div id="story-display">
                <p>Loading your adventure...</p>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="nextScene()" style="flex: 1;">▶️ Continue</button>
                <button onclick="generateSceneImage()" style="flex: 1; background: #7B3F00;">🎨 Generate Scene Art</button>
                <button onclick="downloadAsPDF()" style="flex: 1; background: #654321;">📄 Download PDF</button>
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════════
        // 🎭 NARRATIVE THEATER - CONSOLE DIAGNOSTICS SYSTEM
        // ═══════════════════════════════════════════════════════════════

        console.clear(); // Fresh start

        console.log('%c╔═══════════════════════════════════════════════════════════════════════════╗', 'color: #ff6b35; font-weight: bold; font-size: 16px;');
        console.log('%c║                                                                           ║', 'color: #ff6b35; font-weight: bold; font-size: 16px;');
        console.log('%c║           🎭  THE NARRATIVE THEATER  🎲                                   ║', 'color: #ff6b35; font-weight: bold; font-size: 20px;');
        console.log('%c║                                                                           ║', 'color: #ff6b35; font-weight: bold; font-size: 16px;');
        console.log('%c║           AI-Powered D&D Adventures with Gemini                          ║', 'color: #ff6b35; font-weight: bold; font-size: 14px;');
        console.log('%c║                                                                           ║', 'color: #ff6b35; font-weight: bold; font-size: 16px;');
        console.log('%c╚═══════════════════════════════════════════════════════════════════════════╝', 'color: #ff6b35; font-weight: bold; font-size: 16px;');
        console.log('');
        console.log('%c🚀 System Initialization Starting...', 'color: #3498db; font-size: 14px; font-weight: bold;');
        console.log('');

        console.group('📋 System Information');
        console.log('%cVersion:', 'font-weight: bold;', '2.0.0 (Simple Edition)');
        console.log('%cTimestamp:', 'font-weight: bold;', new Date().toISOString());
        console.log('%cUser Agent:', 'font-weight: bold;', navigator.userAgent);
        console.log('%cScreen Resolution:', 'font-weight: bold;', `${window.screen.width}x${window.screen.height}`);
        console.log('%cViewport:', 'font-weight: bold;', `${window.innerWidth}x${window.innerHeight}`);
        console.log('%cColor Depth:', 'font-weight: bold;', `${window.screen.colorDepth}-bit`);
        console.log('%cLanguage:', 'font-weight: bold;', navigator.language);
        console.log('%cOnline Status:', 'font-weight: bold;', navigator.onLine ? '🟢 Online' : '🔴 Offline');
        console.groupEnd();
        console.log('');

        console.group('🔧 Feature Detection');
        console.log('Fetch API:', typeof fetch !== 'undefined' ? '✅ Available' : '❌ Missing');
        console.log('Local Storage:', typeof localStorage !== 'undefined' ? '✅ Available' : '❌ Missing');
        console.log('Session Storage:', typeof sessionStorage !== 'undefined' ? '✅ Available' : '❌ Missing');
        console.log('Console Styling:', typeof console.log !== 'undefined' ? '✅ Available' : '❌ Missing');
        console.log('Performance API:', typeof performance !== 'undefined' ? '✅ Available' : '❌ Missing');
        console.log('WebGL:', !!document.createElement('canvas').getContext('webgl') ? '✅ Available' : '❌ Missing');
        console.groupEnd();
        console.log('');

        console.log('%c✨ Console logging is FULLY ENHANCED for maximum debugging clarity!', 'color: #2ecc71; font-size: 14px; font-weight: bold;');
        console.log('%c📊 Watch this console for detailed adventure tracking...', 'color: #f39c12; font-size: 12px; font-style: italic;');
        console.log('');
        console.log('%c' + '─'.repeat(80), 'color: #95a5a6;');
        console.log('');

        // Backend configuration
        const BACKEND_URL = 'http://localhost:5002';
        let sessionId = null;

        // Test backend connection on load
        async function testBackend() {
            console.log('%c╔══════════════════════════════════════════════════════════════╗', 'color: #3498db; font-weight: bold; font-size: 14px;');
            console.log('%c║  🌐  TESTING BACKEND CONNECTION                            ║', 'color: #3498db; font-weight: bold; font-size: 14px;');
            console.log('%c╚══════════════════════════════════════════════════════════════╝', 'color: #3498db; font-weight: bold; font-size: 14px;');
            console.log('');

            console.group('🔌 Connection Details');
            console.log('%cBackend URL:', 'font-weight: bold; color: #2980b9;', BACKEND_URL);
            console.log('%cEndpoint:', 'font-weight: bold; color: #2980b9;', `${BACKEND_URL}/health`);
            console.log('%cExpected Response:', 'font-weight: bold; color: #2980b9;', '{ status: "healthy", active_sessions: N }');
            console.groupEnd();
            console.log('');

            const startTime = performance.now();

            try {
                console.log('%c⏳ Sending health check request...', 'color: #f39c12; font-style: italic;');

                const response = await fetch(`${BACKEND_URL}/health`);
                const responseTime = (performance.now() - startTime).toFixed(2);

                console.log(`%c⚡ Response received in ${responseTime}ms`, 'color: #95a5a6; font-style: italic;');
                console.log('Response status:', response.status);
                console.log('Response type:', response.type);
                console.log('Response URL:', response.url);

                const data = await response.json();

                console.log('');
                console.log('%c✅ BACKEND CONNECTION SUCCESSFUL!', 'color: #2ecc71; font-size: 16px; font-weight: bold;');
                console.group('📊 Backend Status');
                console.table({
                    'Status': data.status || 'unknown',
                    'Active Sessions': data.active_sessions || 0,
                    'Available Engines': data.available_engines?.join(', ') || 'N/A',
                    'Response Time': `${responseTime}ms`
                });
                console.log('Full response:', data);
                console.groupEnd();
                console.log('');

                return true;

            } catch (error) {
                const errorTime = (performance.now() - startTime).toFixed(2);

                console.log('');
                console.log('%c❌ BACKEND CONNECTION FAILED!', 'color: #e74c3c; font-size: 16px; font-weight: bold;');
                console.group('🔍 Error Analysis');
                console.error('Error Type:', error.name);
                console.error('Error Message:', error.message);
                console.error('Time Elapsed:', `${errorTime}ms`);
                console.error('Full Error:', error);

                console.log('');
                console.log('%c💡 Troubleshooting Tips:', 'color: #f39c12; font-weight: bold;');
                console.log('  1. Check if server is running: python3 dnd_narrative_server.py');
                console.log('  2. Verify port 5002 is not in use: lsof -i :5002');
                console.log('  3. Check CORS settings on backend');
                console.log('  4. Look for firewall blocking connections');
                console.groupEnd();
                console.log('');

                showStatus('⚠️ Backend not connected. Make sure server is running on port 5002.', 'error');
                return false;
            }
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('start-status');
            const statusContent = document.getElementById('status-content');
            statusDiv.classList.remove('hidden');
            statusContent.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;
            console.log(`[${type}] ${message}`);
        }

        async function startAdventure() {
            console.log('%c═══════════════════════════════════════════════════════════════', 'color: #9b59b6; font-size: 16px; font-weight: bold;');
            console.log('%c🎲 INITIATING ADVENTURE SEQUENCE 🎲', 'color: #9b59b6; font-size: 18px; font-weight: bold;');
            console.log('%c═══════════════════════════════════════════════════════════════', 'color: #9b59b6; font-size: 16px; font-weight: bold;');
            console.log('');

            const model = document.getElementById('modelSelect').value;
            const characterName = document.getElementById('characterName').value;

            console.group('⚙️ Adventure Configuration');
            console.log('%cCharacter Name:', 'font-weight: bold; color: #3498db;', characterName);
            console.log('%cAI Model:', 'font-weight: bold; color: #3498db;', model);
            console.log('%cBackend URL:', 'font-weight: bold; color: #3498db;', `${BACKEND_URL}/start-adventure`);
            console.groupEnd();
            console.log('');

            if (!characterName.trim()) {
                console.warn('⚠️ Character name is empty!');
                showStatus('Please enter a character name!', 'error');
                return;
            }

            console.log('%c[STEP 1/4] 🌐 Connecting to narrative server...', 'color: #f39c12; font-weight: bold;');
            showStatus('Connecting to narrative server...', 'info');

            const startTime = performance.now();

            try {
                console.log('%c[STEP 2/4] 📤 Sending request...', 'color: #f39c12; font-weight: bold;');
                console.log('Request payload:', {
                    model: model,
                    character_name: characterName
                });

                const response = await fetch(`${BACKEND_URL}/start-adventure`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model,
                        character_name: characterName
                    })
                });

                const responseTime = (performance.now() - startTime).toFixed(2);
                console.log(`%c⏱️ Response time: ${responseTime}ms`, 'color: #95a5a6; font-style: italic;');

                console.log('%c[STEP 3/4] 📥 Processing response...', 'color: #f39c12; font-weight: bold;');
                console.log('Response status:', response.status);
                console.log('Response OK:', response.ok ? '✅' : '❌');
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();

                console.log('%c[STEP 4/4] ✨ Adventure data received!', 'color: #2ecc71; font-weight: bold;');
                console.group('📦 Response Summary');
                console.table({
                    'Success': data.success ? '✅' : '❌',
                    'Session ID': data.session_id,
                    'Location': data.location,
                    'Quest Length': data.quest?.length || 0,
                    'Party Size': data.characters?.length || 0,
                    'Scene Available': data.first_scene ? '✅' : '❌'
                });
                console.groupEnd();

                sessionId = data.session_id;
                console.log('%c💾 Session ID stored:', 'color: #1abc9c; font-weight: bold;', sessionId);

                console.log('');
                console.log('%c🎬 Transitioning to story view...', 'color: #e74c3c; font-weight: bold;');
                // Show the story
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('story-screen').classList.remove('hidden');
                console.log('✅ UI transition complete');
                console.log('');

                displayStory(data);

                const totalTime = (performance.now() - startTime).toFixed(2);
                console.log('');
                console.log('%c═══════════════════════════════════════════════════════════════', 'color: #2ecc71; font-size: 16px; font-weight: bold;');
                console.log(`%c✅ ADVENTURE STARTED SUCCESSFULLY! (${totalTime}ms total)`, 'color: #2ecc71; font-size: 18px; font-weight: bold;');
                console.log('%c═══════════════════════════════════════════════════════════════', 'color: #2ecc71; font-size: 16px; font-weight: bold;');
                console.log('');

                // Auto-generate scene image (with error handling)
                console.log('🎨 Checking if image generation services are available...');
                setTimeout(async () => {
                    try {
                        // Quick health check for image services
                        const healthCheck = await fetch(`${BACKEND_URL}/health`, { signal: AbortSignal.timeout(2000) });
                        const health = await healthCheck.json();

                        if (health.status === 'healthy') {
                            console.log('✅ Backend healthy, attempting image generation...');
                            generateSceneImage();
                        } else {
                            console.log('⚠️ Skipping auto-image generation - backend not fully ready');
                        }
                    } catch (error) {
                        console.log('⚠️ Skipping auto-image generation - use manual button if needed');
                    }
                }, 500);

            } catch (error) {
                const errorTime = (performance.now() - startTime).toFixed(2);
                console.log('');
                console.log('%c═══════════════════════════════════════════════════════════════', 'color: #e74c3c; font-size: 16px; font-weight: bold;');
                console.log('%c❌ ADVENTURE START FAILED!', 'color: #e74c3c; font-size: 18px; font-weight: bold;');
                console.log('%c═══════════════════════════════════════════════════════════════', 'color: #e74c3c; font-size: 16px; font-weight: bold;');
                console.group('🔍 Error Details');
                console.error('Error message:', error.message);
                console.error('Error type:', error.name);
                console.error('Full error:', error);
                console.error(`Time elapsed: ${errorTime}ms`);
                console.error('Stack trace:', error.stack);
                console.groupEnd();
                console.log('');

                showStatus(`Failed to start adventure: ${error.message}`, 'error');
            }
        }

        function displayStory(data) {
            console.log('%c╔═══════════════════════════════════════════════════════════════╗', 'color: #ff6b35; font-weight: bold; font-size: 14px;');
            console.log('%c║  🎭  RENDERING NARRATIVE THEATER STORY                      ║', 'color: #ff6b35; font-weight: bold; font-size: 14px;');
            console.log('%c╚═══════════════════════════════════════════════════════════════╝', 'color: #ff6b35; font-weight: bold; font-size: 14px;');
            console.log('');

            console.group('📦 Raw Data Received');
            console.log('Full response object:', data);
            console.log('Data type:', typeof data);
            console.log('Keys available:', Object.keys(data));
            console.groupEnd();
            console.log('');

            // Quest processing with detailed logging
            console.group('🗺️ Quest Processing');
            console.log('Looking for quest in data...');
            console.log('  • data.quest:', data.quest ? '✅ FOUND' : '❌ Missing');
            console.log('  • data.quest_description:', data.quest_description ? '✅ FOUND' : '❌ Missing');
            const quest = data.quest || data.quest_description || 'No quest description available';
            console.log('%c📜 Quest Selected:', 'color: #4ecdc4; font-weight: bold;', quest.substring(0, 100) + '...');
            console.groupEnd();
            console.log('');

            // Character processing with detailed logging
            console.group('👥 Party Processing');
            console.log('Character array exists?', data.characters ? '✅ YES' : '❌ NO');
            console.log('Character count:', data.characters?.length || 0);

            if (data.characters && data.characters.length > 0) {
                data.characters.forEach((char, index) => {
                    console.group(`⚔️ Character ${index + 1}: ${char.name}`);
                    console.log('Raw character data:', char);
                    console.log('Available fields:', Object.keys(char));

                    // Check all possible class field names
                    console.log('Class field mapping:');
                    console.log('  • char.class:', char.class ? `✅ "${char.class}"` : '❌ Missing');
                    console.log('  • char.char_class:', char.char_class ? `✅ "${char.char_class}"` : '❌ Missing');
                    console.log('  • char.character_class:', char.character_class ? `✅ "${char.character_class}"` : '❌ Missing');

                    const selectedClass = char.class || char.char_class || 'Unknown Class';
                    console.log('%c🎯 Selected Class:', 'color: #95e1d3; font-weight: bold;', selectedClass);

                    console.log('Stats:');
                    console.log(`  • HP: ${char.hp}/${char.max_hp}`);
                    console.log(`  • Attack: ${char.attack || 'N/A'}`);
                    console.log(`  • Defense: ${char.defense || 'N/A'}`);
                    console.log(`  • Alive: ${char.alive ? '✅' : '💀'}`);

                    if (char.abilities && char.abilities.length > 0) {
                        console.log('✨ Abilities:', char.abilities.join(', '));
                    }

                    console.groupEnd();
                });
                console.log('%c✅ All characters processed successfully!', 'color: #2ecc71; font-weight: bold;');
            } else {
                console.warn('⚠️ No characters found in response!');
            }
            console.groupEnd();
            console.log('');

            // Scene processing with detailed logging
            console.group('📖 Scene Processing');
            console.log('Looking for scene in data...');
            console.log('  • data.current_scene:', data.current_scene ? '✅ FOUND' : '❌ Missing');
            console.log('  • data.first_scene:', data.first_scene ? '✅ FOUND' : '❌ Missing');

            const scene = data.current_scene || data.first_scene;
            if (scene) {
                console.log('Scene object:', scene);
                console.log('Scene fields:', Object.keys(scene));
                console.log('  • Location:', scene.location || 'Unknown');
                console.log('  • Scene ID:', scene.scene_id);
                console.log('  • Type:', scene.type || 'Unknown');
                console.log('%c🎬 Scene Narrative:', 'color: #f39c12; font-weight: bold;', scene.narrative?.substring(0, 100) + '...');
            } else {
                console.warn('⚠️ No scene found in response!');
            }
            console.groupEnd();
            console.log('');

            // Build HTML with markdown rendering and logging
            console.group('🎨 Building HTML with Markdown');
            const storyDiv = document.getElementById('story-display');
            console.log('Target element:', storyDiv ? '✅ Found' : '❌ Missing');
            console.log('Marked.js available:', typeof marked !== 'undefined' ? '✅ YES' : '❌ NO');

            // Helper function to render markdown
            const renderMarkdown = (text) => {
                if (typeof marked !== 'undefined') {
                    console.log('%c📝 Rendering markdown...', 'color: #9b59b6; font-style: italic;');
                    return marked.parse(text);
                } else {
                    console.warn('⚠️ Marked.js not available, using plain text');
                    return text;
                }
            };

            let html = '<div class="markdown-content">';

            // Quest section with markdown
            html += '<h3>🗺️ Your Quest</h3>';
            const questHtml = renderMarkdown(quest);
            html += questHtml;
            console.log('✅ Quest rendered with markdown');
            console.log('  Quest length:', quest.length, 'chars');
            console.log('  Rendered HTML length:', questHtml.length, 'chars');

            html += '<hr style="margin: 20px 0;">';
            html += '<h3>👥 Your Party</h3>';

            // Characters section (not markdown)
            if (data.characters && data.characters.length > 0) {
                data.characters.forEach(char => {
                    const charClass = char.class || char.char_class || 'Unknown Class';
                    const charHTML = `<p>⚔️ <strong>${char.name}</strong> - ${charClass} (HP: ${char.hp}/${char.max_hp})</p>`;
                    html += charHTML;
                    console.log(`✅ Character HTML added: ${char.name} - ${charClass}`);
                });
            }

            // Scene section with markdown
            if (scene) {
                html += '<hr style="margin: 20px 0;">';
                html += '<h3>📖 Current Scene</h3>';
                const narrative = scene.narrative || 'No scene description available';
                const sceneHtml = renderMarkdown(narrative);
                html += sceneHtml;
                console.log('✅ Scene rendered with markdown');
                console.log('  Narrative length:', narrative.length, 'chars');
                console.log('  Rendered HTML length:', sceneHtml.length, 'chars');
            }

            html += '</div>';

            storyDiv.innerHTML = html;
            console.log('✅ HTML injected into DOM');
            console.log('  Final HTML size:', html.length, 'chars');
            console.groupEnd();
            console.log('');

            console.log('%c╔═══════════════════════════════════════════════════════════════╗', 'color: #2ecc71; font-weight: bold; font-size: 14px;');
            console.log('%c║  ✨  STORY RENDERING COMPLETE!                              ║', 'color: #2ecc71; font-weight: bold; font-size: 14px;');
            console.log('%c╚═══════════════════════════════════════════════════════════════╝', 'color: #2ecc71; font-weight: bold; font-size: 14px;');
            console.log('');
        }

        async function nextScene() {
            console.log('▶️ Getting next scene...');

            if (!sessionId) {
                console.error('No session ID');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/next-scene`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        player_action: 'continue'
                    })
                });

                const data = await response.json();
                console.log('✅ Next scene:', data);

                const storyDiv = document.getElementById('story-display');
                storyDiv.innerHTML += `<hr style="margin: 20px 0;"><p>${data.narrative}</p>`;

            } catch (error) {
                console.error('❌ Error getting next scene:', error);
            }
        }

        async function generateSceneImage() {
            console.log('%c╔═══════════════════════════════════════════════════════════════╗', 'color: #7B3F00; font-weight: bold; font-size: 14px;');
            console.log('%c║  🎨  GENERATING SCENE ARTWORK                               ║', 'color: #7B3F00; font-weight: bold; font-size: 14px;');
            console.log('%c╚═══════════════════════════════════════════════════════════════╝', 'color: #7B3F00; font-weight: bold; font-size: 14px;');
            console.log('');

            if (!sessionId) {
                console.error('❌ No session ID - cannot generate image');
                alert('Please start an adventure first!');
                return;
            }

            // Show loading overlay
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = '✨ Generating your adventure artwork...';
            console.log('🎨 Loading animation displayed');

            try {
                console.log('🎨 Requesting scene image generation...');
                const startTime = performance.now();

                // Add timeout to prevent infinite loading
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.warn('⏰ Request timeout after 30 seconds');
                }, 30000); // 30 second timeout

                const response = await fetch(`${BACKEND_URL}/generate-scene-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                const responseTime = (performance.now() - startTime).toFixed(2);
                console.log(`⏱️ Image generation time: ${responseTime}ms`);

                const data = await response.json();
                console.log('✅ Image generation response:', data);

                if (data.success && (data.image_url || data.image)) {
                    console.log('%c🖼️ Image ready!', 'color: #2ecc71; font-weight: bold;');

                    // Handle both URL and base64 image data
                    let imageSrc;
                    if (data.image_url) {
                        imageSrc = data.image_url;
                        console.log('Image URL:', data.image_url);
                    } else if (data.image) {
                        // Base64 data - determine format
                        const imageType = data.image_type || 'png';
                        imageSrc = `data:image/${imageType};base64,${data.image}`;
                        console.log('Base64 image data received');
                        console.log('Image type:', imageType);
                        console.log('Data length:', data.image.length, 'chars');
                    }

                    // Display the image
                    const imageContainer = document.getElementById('scene-image-container');
                    const imageElement = document.getElementById('scene-image');
                    imageElement.src = imageSrc;
                    imageContainer.classList.remove('hidden');

                    console.log('✅ Image displayed in page');

                    // Hide loading overlay
                    loadingOverlay.classList.add('hidden');
                } else {
                    throw new Error(data.error || 'Image generation failed - no image data received');
                }

            } catch (error) {
                console.error('%c❌ Image generation failed!', 'color: #e74c3c; font-weight: bold;');
                console.error('Error:', error.message);
                console.error('Full error:', error);

                // Hide loading overlay
                loadingOverlay.classList.add('hidden');

                // User-friendly error message
                const errorMsg = error.message.includes('fetch')
                    ? 'Cannot connect to backend. Is the server running on port 5002?'
                    : 'Image generation failed. Make sure PixelLab Bridge (port 5001) and Nano-Banana (port 5000) are running.';
                alert(errorMsg);
            }
        }

        async function downloadAsPDF() {
            console.log('%c╔═══════════════════════════════════════════════════════════════╗', 'color: #654321; font-weight: bold; font-size: 14px;');
            console.log('%c║  📄  GENERATING PDF EXPORT                                  ║', 'color: #654321; font-weight: bold; font-size: 14px;');
            console.log('%c╚═══════════════════════════════════════════════════════════════╝', 'color: #654321; font-weight: bold; font-size: 14px;');
            console.log('');

            try {
                console.log('📄 Initializing PDF generation...');
                console.log('jsPDF available:', typeof jspdf !== 'undefined' ? '✅ YES' : '❌ NO');
                console.log('html2canvas available:', typeof html2canvas !== 'undefined' ? '✅ YES' : '❌ NO');

                const startTime = performance.now();

                // Get the story content
                const storyScreen = document.getElementById('story-screen');

                console.log('🎨 Capturing page content with html2canvas...');
                const canvas = await html2canvas(storyScreen, {
                    backgroundColor: '#F5DEB3',
                    scale: 2,
                    logging: false
                });

                const captureTime = (performance.now() - startTime).toFixed(2);
                console.log(`✅ Canvas captured in ${captureTime}ms`);
                console.log('Canvas size:', canvas.width, 'x', canvas.height);

                // Create PDF
                console.log('📝 Creating PDF document...');
                const { jsPDF } = jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Add the canvas as an image
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                console.log('Adding image to PDF...');
                console.log('  Image dimensions:', imgWidth, 'x', imgHeight, 'mm');

                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

                // Generate filename with timestamp
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `narrative-theater-${timestamp}.pdf`;

                console.log('💾 Saving PDF as:', filename);
                pdf.save(filename);

                const totalTime = (performance.now() - startTime).toFixed(2);
                console.log('');
                console.log('%c✅ PDF EXPORT SUCCESSFUL!', 'color: #2ecc71; font-size: 16px; font-weight: bold;');
                console.log(`Total time: ${totalTime}ms`);
                console.log('Filename:', filename);
                console.log('');

            } catch (error) {
                console.error('%c❌ PDF EXPORT FAILED!', 'color: #e74c3c; font-weight: bold;');
                console.error('Error:', error.message);
                console.error('Full error:', error);
                alert('PDF generation failed: ' + error.message);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('%c' + '─'.repeat(80), 'color: #95a5a6;');
            console.log('');
            console.log('%c🎬 DOM CONTENT LOADED EVENT FIRED', 'color: #9b59b6; font-size: 16px; font-weight: bold;');
            console.log('');

            console.group('🔍 DOM Element Check');
            const elements = {
                'start-screen': document.getElementById('start-screen'),
                'story-screen': document.getElementById('story-screen'),
                'characterName': document.getElementById('characterName'),
                'modelSelect': document.getElementById('modelSelect'),
                'start-status': document.getElementById('start-status')
            };

            for (const [id, element] of Object.entries(elements)) {
                console.log(`${element ? '✅' : '❌'} #${id}:`, element ? 'Found' : 'Missing');
            }
            console.groupEnd();
            console.log('');

            console.log('%c🔌 Initiating backend connection test...', 'color: #3498db; font-weight: bold;');
            console.log('');

            const connected = await testBackend();

            if (connected) {
                console.log('%c🎉 System fully initialized and ready for adventures!', 'color: #2ecc71; font-size: 14px; font-weight: bold;');
            } else {
                console.log('%c⚠️ System initialized but backend is offline', 'color: #e67e22; font-size: 14px; font-weight: bold;');
            }

            console.log('');
            console.log('%c' + '═'.repeat(80), 'color: #95a5a6;');
            console.log('%c🎭 READY FOR ADVENTURES! Check out the console as you play! 🎲', 'color: #ff6b35; font-size: 16px; font-weight: bold; text-align: center;');
            console.log('%c' + '═'.repeat(80), 'color: #95a5a6;');
            console.log('');
        });

        console.log('');
        console.log('%c✅ Script Parsing Complete', 'color: #2ecc71; font-weight: bold;');
        console.log('%c⏳ Waiting for DOM to load...', 'color: #f39c12; font-style: italic;');
        console.log('');
    </script>
</body>
</html>
