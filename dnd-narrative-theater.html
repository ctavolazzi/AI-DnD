<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ The Narrative Theater üé≤ - Simple Version</title>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas for capturing page content -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(90deg, #8B4513 0%, #A0522D 50%, #8B4513 100%);
            color: #2c1810;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 25px;
            background: linear-gradient(180deg, #d2691e 0%, #8B4513 100%);
            border: 4px solid #3e2723;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 42px;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
        }

        .subtitle {
            color: #ffecb3;
            font-size: 16px;
            margin-top: 10px;
        }

        .start-screen {
            text-align: center;
            padding: 60px 20px;
            background: rgba(210, 105, 30, 0.3);
            border: 3px solid #3e2723;
            border-radius: 8px;
        }

        .start-screen h2 {
            font-size: 32px;
            color: #3e2723;
            margin-bottom: 20px;
        }

        .start-screen p {
            font-size: 18px;
            color: #5d4037;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .controls {
            background: rgba(255,236,179,0.6);
            border: 2px solid #8B4513;
            border-radius: 6px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #3e2723;
        }

        select, input {
            width: 100%;
            padding: 10px;
            border: 2px solid #8B4513;
            border-radius: 4px;
            background: white;
            font-size: 16px;
            margin-bottom: 15px;
        }

        button {
            background: #8B4513;
            color: #ffd700;
            border: 2px solid #3e2723;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-weight: bold;
            width: 100%;
        }

        button:hover {
            background: #A0522D;
            transform: scale(1.02);
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border: 2px solid #3e2723;
            border-radius: 6px;
            text-align: left;
        }

        .hidden {
            display: none;
        }

        .story-content {
            background: rgba(255,236,179,0.6);
            border: 2px solid #8B4513;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
        }

        /* Markdown Styling */
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            color: #3e2723;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .markdown-content h1 {
            font-size: 28px;
            border-bottom: 3px solid #8B4513;
            padding-bottom: 10px;
        }

        .markdown-content h2 {
            font-size: 24px;
            border-bottom: 2px solid #A0522D;
            padding-bottom: 8px;
        }

        .markdown-content h3 {
            font-size: 20px;
            color: #5d4037;
        }

        .markdown-content p {
            margin: 15px 0;
            line-height: 1.8;
        }

        .markdown-content strong {
            color: #3e2723;
            font-weight: bold;
        }

        .markdown-content em {
            color: #5d4037;
            font-style: italic;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        .markdown-content li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .markdown-content blockquote {
            border-left: 4px solid #8B4513;
            padding-left: 20px;
            margin: 15px 0;
            font-style: italic;
            color: #5d4037;
            background: rgba(139, 69, 19, 0.1);
            padding: 15px 20px;
            border-radius: 4px;
        }

        .markdown-content code {
            background: rgba(62, 39, 35, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .markdown-content pre {
            background: rgba(62, 39, 35, 0.1);
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 15px 0;
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
        }

        .markdown-content hr {
            border: none;
            border-top: 2px solid #8B4513;
            margin: 25px 0;
        }

        .markdown-content a {
            color: #8B4513;
            text-decoration: underline;
        }

        .markdown-content a:hover {
            color: #A0522D;
        }

        /* Loading Animation */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #8B4513;
            border-top: 4px solid #F5DEB3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Portrait loading spinner (small, inside portrait box) */
        .portrait-spinner {
            border: 4px solid rgba(255, 215, 0, 0.2);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Scene image loading spinner (large) */
        .scene-image-spinner {
            border: 12px solid rgba(255, 215, 0, 0.2);
            border-top: 12px solid #FFD700;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }

        .image-loading-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-text {
            color: #F5DEB3;
            font-size: 24px;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden" style="display: none !important;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">‚ú® Generating your adventure artwork...</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üé≠ THE NARRATIVE THEATER üé≤</h1>
            <div class="subtitle">Where Stories Come Alive ‚Ä¢ AI-Powered D&D Adventures</div>
        </div>

        <div id="start-screen" class="start-screen">
            <h2>Welcome, Adventurer!</h2>
            <p>
                Embark on an epic journey where narrative and imagery merge.<br>
                Your choices shape the story, and every moment can be visualized.<br>
                The theater awaits...
            </p>

            <div class="controls">
                <label for="modelSelect">ü§ñ AI Model:</label>
                <select id="modelSelect">
                    <option value="gemini">Gemini 2.5 Flash (Recommended)</option>
                    <option value="ollama">Ollama (Local)</option>
                </select>

                <label for="characterName">‚öîÔ∏è Your Character Name:</label>
                <input type="text" id="characterName" placeholder="Enter your hero's name..." value="Thorin">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <label for="storyPrompt" style="margin-bottom: 0;">üìñ What is our story about today?</label>
                    <button onclick="randomizeStory(event)"
                        style="padding: 5px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s ease;"
                        onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';"
                        onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';"
                        title="Generate random story prompt">
                        üé≤ Randomize
                    </button>
                </div>
                <textarea id="storyPrompt"
                    placeholder="Describe the adventure... (e.g., 'A quest to find a lost artifact in an ancient temple' or 'Defending a village from a dragon attack')"
                    rows="3"
                    style="resize: vertical; font-family: Georgia, serif; line-height: 1.5;"></textarea>

                <button onclick="startAdventure()">üé≤ Start Your Adventure</button>
                </div>

            <div id="start-status" class="status hidden">
                <h3>Status:</h3>
                <div id="status-content">Ready to begin...</div>
                </div>
                </div>

        <div id="story-screen" class="story-content hidden">
            <h2>üìñ Your Adventure</h2>

            <!-- Image Gallery - Multiple generated images -->
            <div id="scene-image-container" class="hidden" style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #1a0f08 0%, #2c1810 100%); border-radius: 15px; border: 3px solid #8B4513;">
                <h3 style="color: #FFD700; margin: 0 0 20px 0; text-align: center;">üñºÔ∏è Scene Artwork Gallery</h3>

                <!-- PixelLab Sprite (small pixel art) -->
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #FFA500; margin: 0 0 10px 0;">üéÆ Pixel Art Scene (PixelLab)</h4>
                    <div style="text-align: center; background: #000; padding: 20px; border-radius: 10px; border: 2px solid #444;">
                        <div id="sprite-loading" class="scene-image-spinner"></div>
                        <img id="sprite-image" style="width: auto; height: 256px; image-rendering: pixelated; border-radius: 8px; display: none; margin: 0 auto;" alt="Pixel art scene">
                        </div>
                        </div>

                <!-- Nano Banana Landscape (large high-res) -->
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #FFA500; margin: 0 0 10px 0;">üé® AI-Enhanced Landscape (Nano Banana 16:9)</h4>
                    <div style="text-align: center; background: #000; padding: 20px; border-radius: 10px; border: 2px solid #444;">
                        <div id="landscape-loading" class="scene-image-spinner"></div>
                        <img id="landscape-image" style="width: 100%; max-width: 1200px; height: auto; border-radius: 12px; border: 4px solid #FFD700; box-shadow: 0 8px 20px rgba(0,0,0,0.6); display: none;" alt="Landscape scene">
                    </div>
                        </div>

                <!-- Enhanced Sprite-to-Art Pipeline -->
                <div>
                    <h4 style="color: #FFA500; margin: 0 0 10px 0;">‚ú® Enhanced Pipeline (Sprite ‚Üí Nano Banana)</h4>
                    <div style="text-align: center; background: #000; padding: 20px; border-radius: 10px; border: 2px solid #444;">
                        <div id="enhanced-loading" class="scene-image-spinner"></div>
                        <img id="enhanced-image" style="width: 100%; max-width: 1200px; height: auto; border-radius: 12px; border: 4px solid #9B59B6; box-shadow: 0 8px 20px rgba(0,0,0,0.6); display: none;" alt="Enhanced artwork">
                        <p id="enhanced-status" style="color: #9B59B6; margin-top: 10px; font-size: 14px;"></p>
                        </div>
                    </div>
                </div>

            <div id="story-display">
                <p>Loading your adventure...</p>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="nextScene()" style="flex: 1;">‚ñ∂Ô∏è Continue</button>
                <button onclick="generateSceneImage()" style="flex: 1; background: #7B3F00;">üé® Generate Scene Art</button>
                <button onclick="downloadAsPDF()" style="flex: 1; background: #654321;">üìÑ Download PDF</button>
                </div>
        </div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üé≠ NARRATIVE THEATER - CONSOLE DIAGNOSTICS SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        console.clear(); // Fresh start

        console.log('%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó', 'color: #ff6b35; font-weight: bold; font-size: 16px;');
        console.log('%c‚ïë                                                                           ‚ïë', 'color: #ff6b35; font-weight: bold; font-size: 16px;');
        console.log('%c‚ïë           üé≠  THE NARRATIVE THEATER  üé≤                                   ‚ïë', 'color: #ff6b35; font-weight: bold; font-size: 20px;');
        console.log('%c‚ïë                                                                           ‚ïë', 'color: #ff6b35; font-weight: bold; font-size: 16px;');
        console.log('%c‚ïë           AI-Powered D&D Adventures with Gemini                          ‚ïë', 'color: #ff6b35; font-weight: bold; font-size: 14px;');
        console.log('%c‚ïë                                                                           ‚ïë', 'color: #ff6b35; font-weight: bold; font-size: 16px;');
        console.log('%c‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù', 'color: #ff6b35; font-weight: bold; font-size: 16px;');
        console.log('');
        console.log('%cüöÄ System Initialization Starting...', 'color: #3498db; font-size: 14px; font-weight: bold;');
        console.log('');

        console.group('üìã System Information');
        console.log('%cVersion:', 'font-weight: bold;', '2.0.0 (Simple Edition)');
        console.log('%cTimestamp:', 'font-weight: bold;', new Date().toISOString());
        console.log('%cUser Agent:', 'font-weight: bold;', navigator.userAgent);
        console.log('%cScreen Resolution:', 'font-weight: bold;', `${window.screen.width}x${window.screen.height}`);
        console.log('%cViewport:', 'font-weight: bold;', `${window.innerWidth}x${window.innerHeight}`);
        console.log('%cColor Depth:', 'font-weight: bold;', `${window.screen.colorDepth}-bit`);
        console.log('%cLanguage:', 'font-weight: bold;', navigator.language);
        console.log('%cOnline Status:', 'font-weight: bold;', navigator.onLine ? 'üü¢ Online' : 'üî¥ Offline');
        console.groupEnd();
        console.log('');

        console.group('üîß Feature Detection');
        console.log('Fetch API:', typeof fetch !== 'undefined' ? '‚úÖ Available' : '‚ùå Missing');
        console.log('Local Storage:', typeof localStorage !== 'undefined' ? '‚úÖ Available' : '‚ùå Missing');
        console.log('Session Storage:', typeof sessionStorage !== 'undefined' ? '‚úÖ Available' : '‚ùå Missing');
        console.log('Console Styling:', typeof console.log !== 'undefined' ? '‚úÖ Available' : '‚ùå Missing');
        console.log('Performance API:', typeof performance !== 'undefined' ? '‚úÖ Available' : '‚ùå Missing');
        console.log('WebGL:', !!document.createElement('canvas').getContext('webgl') ? '‚úÖ Available' : '‚ùå Missing');
        console.groupEnd();
        console.log('');

        console.log('%c‚ú® Console logging is FULLY ENHANCED for maximum debugging clarity!', 'color: #2ecc71; font-size: 14px; font-weight: bold;');
        console.log('%cüìä Watch this console for detailed adventure tracking...', 'color: #f39c12; font-size: 12px; font-style: italic;');
        console.log('');
        console.log('%c' + '‚îÄ'.repeat(80), 'color: #95a5a6;');
        console.log('');

        // Backend configuration
        const BACKEND_URL = 'http://localhost:5002';
        let sessionId = null;

        // Story prompt templates for randomization
        const STORY_PROMPTS = [
            // Classic Quests
            "Retrieve a legendary artifact from an ancient temple guarded by deadly traps",
            "Find and return the stolen crown of a fallen kingdom before war breaks out",
            "Discover the source of mysterious disappearances in a cursed forest",
            "Rescue the princess from a dragon's lair high in the mountains",
            "Uncover the secret behind strange magical disturbances in the city",

            // Dark & Mysterious
            "Investigate a haunted mansion where guests have vanished without a trace",
            "Solve murders in a city where the dead are rising from their graves",
            "Stop a dark ritual that threatens to summon an ancient evil",
            "Explore cursed ruins where shadows seem to have minds of their own",
            "Track down a vampire lord terrorizing villages under the full moon",

            // Epic Adventures
            "Defend the last standing fortress against an invading army of orcs",
            "Unite the scattered clans to fight against a demon invasion",
            "Journey to the underworld to retrieve a soul wrongly taken",
            "Prevent the awakening of a sleeping titan that will destroy the world",
            "Find the legendary sword that can seal away the darkness forever",

            // Exploration & Discovery
            "Chart unknown waters to discover the mythical Sunken City of Azmar",
            "Explore floating islands in the sky searching for ancient technology",
            "Venture into the Underdark to find a rare healing herb for a plague",
            "Discover what lies beyond the forbidden portal in the wizard's tower",
            "Map the labyrinthine caves rumored to hold a dragon's treasure hoard",

            // Political Intrigue
            "Uncover a conspiracy to assassinate the king during the royal ball",
            "Navigate deadly court politics to become the new guild master",
            "Mediate peace between two warring factions before total war erupts",
            "Expose corruption in the city guard before the innocent are executed",
            "Infiltrate a thieves' guild to recover stolen royal documents",

            // Survival & Horror
            "Survive a night in a manor where reality itself seems to break down",
            "Escape from an underground prison built by a mad wizard",
            "Navigate a city overtaken by a zombie plague seeking the cure",
            "Survive the wilderness after a shipwreck on a hostile island",
            "Escape a time loop that resets every midnight with deadly consequences",

            // Unusual & Creative
            "Help a ghost find peace by solving the mystery of their murder",
            "Stop a bard whose cursed songs are driving people to madness",
            "Investigate why all the cats in the city have gone missing",
            "Resolve a dispute between warring factions of druids and loggers",
            "Recover memories stolen by a mischievous fey creature",

            // High Stakes
            "Prevent a mad mage from collapsing reality by fixing magical ley lines",
            "Stop a plague of magical corruption spreading across the land",
            "Save a city from sinking into the ocean by appeasing sea gods",
            "Prevent a prophecy that foretells the end of all magic",
            "Close dimensional rifts before creatures from the void consume reality",

            // Personal Quests
            "Avenge your village destroyed by bandits and bring them to justice",
            "Find your lost sibling who was kidnapped by slavers years ago",
            "Prove your innocence after being framed for a crime you didn't commit",
            "Earn your place in the legendary order of knights through trials",
            "Discover the truth about your mysterious magical heritage",

            // Comic Relief / Light-Hearted
            "Help a dragon who has lost their voice get it back before a concert",
            "Recover a bakery's secret recipe stolen by rival pastry chefs",
            "Organize the most epic tavern brawl tournament the realm has ever seen",
            "Rescue a prince who doesn't want to be rescued from his comfortable prison",
            "Help a lich who wants to retire and become mortal again"
        ];

        // Randomize story prompt
        function randomizeStory(event) {
            const textarea = document.getElementById('storyPrompt');
            const randomPrompt = STORY_PROMPTS[Math.floor(Math.random() * STORY_PROMPTS.length)];

            // Smooth animation
            textarea.style.opacity = '0.5';
            textarea.value = '';

            setTimeout(() => {
                textarea.value = randomPrompt;
                textarea.style.opacity = '1';

                // Visual feedback on button
                if (event && event.target) {
                    const button = event.target;
                    const originalText = button.innerHTML;
                    button.innerHTML = '‚ú® Nice!';
                    button.style.background = 'linear-gradient(135deg, #56ab2f 0%, #a8e063 100%)';

                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    }, 1000);
                }
            }, 200);

            console.log('üé≤ Randomized story prompt:', randomPrompt);
        }

        // Test backend connection on load
        async function testBackend() {
            console.log('%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó', 'color: #3498db; font-weight: bold; font-size: 14px;');
            console.log('%c‚ïë  üåê  TESTING BACKEND CONNECTION                            ‚ïë', 'color: #3498db; font-weight: bold; font-size: 14px;');
            console.log('%c‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù', 'color: #3498db; font-weight: bold; font-size: 14px;');
            console.log('');

            console.group('üîå Connection Details');
            console.log('%cBackend URL:', 'font-weight: bold; color: #2980b9;', BACKEND_URL);
            console.log('%cEndpoint:', 'font-weight: bold; color: #2980b9;', `${BACKEND_URL}/health`);
            console.log('%cExpected Response:', 'font-weight: bold; color: #2980b9;', '{ status: "healthy", active_sessions: N }');
            console.groupEnd();
            console.log('');

            const startTime = performance.now();

            try {
                console.log('%c‚è≥ Sending health check request...', 'color: #f39c12; font-style: italic;');

                const response = await fetch(`${BACKEND_URL}/health`);
                const responseTime = (performance.now() - startTime).toFixed(2);

                console.log(`%c‚ö° Response received in ${responseTime}ms`, 'color: #95a5a6; font-style: italic;');
                console.log('Response status:', response.status);
                console.log('Response type:', response.type);
                console.log('Response URL:', response.url);

                const data = await response.json();

                console.log('');
                console.log('%c‚úÖ BACKEND CONNECTION SUCCESSFUL!', 'color: #2ecc71; font-size: 16px; font-weight: bold;');
                console.group('üìä Backend Status');
                console.table({
                    'Status': data.status || 'unknown',
                    'Active Sessions': data.active_sessions || 0,
                    'Available Engines': data.available_engines?.join(', ') || 'N/A',
                    'Response Time': `${responseTime}ms`
                });
                console.log('Full response:', data);
                console.groupEnd();
                console.log('');

                return true;

            } catch (error) {
                const errorTime = (performance.now() - startTime).toFixed(2);

                console.log('');
                console.log('%c‚ùå BACKEND CONNECTION FAILED!', 'color: #e74c3c; font-size: 16px; font-weight: bold;');
                console.group('üîç Error Analysis');
                console.error('Error Type:', error.name);
                console.error('Error Message:', error.message);
                console.error('Time Elapsed:', `${errorTime}ms`);
                console.error('Full Error:', error);

                console.log('');
                console.log('%cüí° Troubleshooting Tips:', 'color: #f39c12; font-weight: bold;');
                console.log('  1. Check if server is running: python3 dnd_narrative_server.py');
                console.log('  2. Verify port 5002 is not in use: lsof -i :5002');
                console.log('  3. Check CORS settings on backend');
                console.log('  4. Look for firewall blocking connections');
                console.groupEnd();
                console.log('');

                showStatus('‚ö†Ô∏è Backend not connected. Make sure server is running on port 5002.', 'error');
                return false;
            }
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('start-status');
            const statusContent = document.getElementById('status-content');
            statusDiv.classList.remove('hidden');
            statusContent.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;
            console.log(`[${type}] ${message}`);
        }

        async function startAdventure() {
            console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #9b59b6; font-size: 16px; font-weight: bold;');
            console.log('%cüé≤ INITIATING ADVENTURE SEQUENCE üé≤', 'color: #9b59b6; font-size: 18px; font-weight: bold;');
            console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #9b59b6; font-size: 16px; font-weight: bold;');
            console.log('');

            const model = document.getElementById('modelSelect').value;
            const characterName = document.getElementById('characterName').value;
            const storyPrompt = document.getElementById('storyPrompt').value;

            console.group('‚öôÔ∏è Adventure Configuration');
            console.log('%cCharacter Name:', 'font-weight: bold; color: #3498db;', characterName);
            console.log('%cAI Model:', 'font-weight: bold; color: #3498db;', model);
            console.log('%cStory Prompt:', 'font-weight: bold; color: #3498db;', storyPrompt || 'Random adventure');
            console.log('%cBackend URL:', 'font-weight: bold; color: #3498db;', `${BACKEND_URL}/start-adventure`);
            console.groupEnd();
            console.log('');

            if (!characterName.trim()) {
                console.warn('‚ö†Ô∏è Character name is empty!');
                showStatus('Please enter a character name!', 'error');
                return;
            }

            console.log('%c[STEP 1/4] üåê Connecting to narrative server...', 'color: #f39c12; font-weight: bold;');
            showStatus('Connecting to narrative server...', 'info');

            const startTime = performance.now();

            try {
                console.log('%c[STEP 2/4] üì§ Sending request...', 'color: #f39c12; font-weight: bold;');
                const requestPayload = {
                    model: model,
                    character_name: characterName
                };

                // Add story_prompt if provided
                if (storyPrompt && storyPrompt.trim()) {
                    requestPayload.story_prompt = storyPrompt.trim();
                }

                console.log('Request payload:', requestPayload);

                const response = await fetch(`${BACKEND_URL}/start-adventure`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestPayload)
                });

                const responseTime = (performance.now() - startTime).toFixed(2);
                console.log(`%c‚è±Ô∏è Response time: ${responseTime}ms`, 'color: #95a5a6; font-style: italic;');

                console.log('%c[STEP 3/4] üì• Processing response...', 'color: #f39c12; font-weight: bold;');
                console.log('Response status:', response.status);
                console.log('Response OK:', response.ok ? '‚úÖ' : '‚ùå');
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();

                console.log('%c[STEP 4/4] ‚ú® Adventure data received!', 'color: #2ecc71; font-weight: bold;');
                console.group('üì¶ Response Summary');
                console.table({
                    'Success': data.success ? '‚úÖ' : '‚ùå',
                    'Session ID': data.session_id,
                    'Location': data.location,
                    'Quest Length': data.quest?.length || 0,
                    'Party Size': data.characters?.length || 0,
                    'Scene Available': data.first_scene ? '‚úÖ' : '‚ùå'
                });
                console.groupEnd();

                sessionId = data.session_id;
                console.log('%cüíæ Session ID stored:', 'color: #1abc9c; font-weight: bold;', sessionId);

                console.log('');
                console.log('%cüé¨ Transitioning to story view...', 'color: #e74c3c; font-weight: bold;');
                // Show the story
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('story-screen').classList.remove('hidden');
                console.log('‚úÖ UI transition complete');
                console.log('');

                displayStory(data);

                const totalTime = (performance.now() - startTime).toFixed(2);
                console.log('');
                console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #2ecc71; font-size: 16px; font-weight: bold;');
                console.log(`%c‚úÖ ADVENTURE STARTED SUCCESSFULLY! (${totalTime}ms total)`, 'color: #2ecc71; font-size: 18px; font-weight: bold;');
                console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #2ecc71; font-size: 16px; font-weight: bold;');
                console.log('');
                console.log('üí° Click "üé® Generate Scene Art" button to create an image!');
                console.log('');

            } catch (error) {
                const errorTime = (performance.now() - startTime).toFixed(2);
                console.log('');
                console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #e74c3c; font-size: 16px; font-weight: bold;');
                console.log('%c‚ùå ADVENTURE START FAILED!', 'color: #e74c3c; font-size: 18px; font-weight: bold;');
                console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #e74c3c; font-size: 16px; font-weight: bold;');
                console.group('üîç Error Details');
                console.error('Error message:', error.message);
                console.error('Error type:', error.name);
                console.error('Full error:', error);
                console.error(`Time elapsed: ${errorTime}ms`);
                console.error('Stack trace:', error.stack);
                console.groupEnd();
                console.log('');

                showStatus(`Failed to start adventure: ${error.message}`, 'error');
            }
        }

        function displayStory(data) {
            console.log('%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó', 'color: #ff6b35; font-weight: bold; font-size: 14px;');
            console.log('%c‚ïë  üé≠  RENDERING NARRATIVE THEATER STORY                      ‚ïë', 'color: #ff6b35; font-weight: bold; font-size: 14px;');
            console.log('%c‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù', 'color: #ff6b35; font-weight: bold; font-size: 14px;');
            console.log('');

            console.group('üì¶ Raw Data Received');
            console.log('Full response object:', data);
            console.log('Data type:', typeof data);
            console.log('Keys available:', Object.keys(data));
            console.groupEnd();
            console.log('');

            // Quest processing with detailed logging
            console.group('üó∫Ô∏è Quest Processing');
            console.log('Looking for quest in data...');
            console.log('  ‚Ä¢ data.quest:', data.quest ? '‚úÖ FOUND' : '‚ùå Missing');
            console.log('  ‚Ä¢ data.quest_description:', data.quest_description ? '‚úÖ FOUND' : '‚ùå Missing');
            const quest = data.quest || data.quest_description || 'No quest description available';
            console.log('%cüìú Quest Selected:', 'color: #4ecdc4; font-weight: bold;', quest.substring(0, 100) + '...');
            console.groupEnd();
            console.log('');

            // Character processing with detailed logging
            console.group('üë• Party Processing');
            console.log('Character array exists?', data.characters ? '‚úÖ YES' : '‚ùå NO');
            console.log('Character count:', data.characters?.length || 0);

            if (data.characters && data.characters.length > 0) {
                data.characters.forEach((char, index) => {
                    console.group(`‚öîÔ∏è Character ${index + 1}: ${char.name}`);
                    console.log('Raw character data:', char);
                    console.log('Available fields:', Object.keys(char));

                    // Check all possible class field names
                    console.log('Class field mapping:');
                    console.log('  ‚Ä¢ char.class:', char.class ? `‚úÖ "${char.class}"` : '‚ùå Missing');
                    console.log('  ‚Ä¢ char.char_class:', char.char_class ? `‚úÖ "${char.char_class}"` : '‚ùå Missing');
                    console.log('  ‚Ä¢ char.character_class:', char.character_class ? `‚úÖ "${char.character_class}"` : '‚ùå Missing');

                    const selectedClass = char.class || char.char_class || 'Unknown Class';
                    console.log('%cüéØ Selected Class:', 'color: #95e1d3; font-weight: bold;', selectedClass);

                    console.log('Stats:');
                    console.log(`  ‚Ä¢ HP: ${char.hp}/${char.max_hp}`);
                    console.log(`  ‚Ä¢ Attack: ${char.attack || 'N/A'}`);
                    console.log(`  ‚Ä¢ Defense: ${char.defense || 'N/A'}`);
                    console.log(`  ‚Ä¢ Alive: ${char.alive ? '‚úÖ' : 'üíÄ'}`);

                    if (char.abilities && char.abilities.length > 0) {
                        console.log('‚ú® Abilities:', char.abilities.join(', '));
                    }

                    console.groupEnd();
                });
                console.log('%c‚úÖ All characters processed successfully!', 'color: #2ecc71; font-weight: bold;');
            } else {
                console.warn('‚ö†Ô∏è No characters found in response!');
            }
            console.groupEnd();
            console.log('');

            // Scene processing with detailed logging
            console.group('üìñ Scene Processing');
            console.log('Looking for scene in data...');
            console.log('  ‚Ä¢ data.current_scene:', data.current_scene ? '‚úÖ FOUND' : '‚ùå Missing');
            console.log('  ‚Ä¢ data.first_scene:', data.first_scene ? '‚úÖ FOUND' : '‚ùå Missing');

            const scene = data.current_scene || data.first_scene;
            if (scene) {
                console.log('Scene object:', scene);
                console.log('Scene fields:', Object.keys(scene));
                console.log('  ‚Ä¢ Location:', scene.location || 'Unknown');
                console.log('  ‚Ä¢ Scene ID:', scene.scene_id);
                console.log('  ‚Ä¢ Type:', scene.type || 'Unknown');
                console.log('%cüé¨ Scene Narrative:', 'color: #f39c12; font-weight: bold;', scene.narrative?.substring(0, 100) + '...');
                } else {
                console.warn('‚ö†Ô∏è No scene found in response!');
            }
            console.groupEnd();
            console.log('');

            // Build HTML with markdown rendering and logging
            console.group('üé® Building HTML with Markdown');
            const storyDiv = document.getElementById('story-display');
            console.log('Target element:', storyDiv ? '‚úÖ Found' : '‚ùå Missing');
            console.log('Marked.js available:', typeof marked !== 'undefined' ? '‚úÖ YES' : '‚ùå NO');

            // Helper function to render markdown
            const renderMarkdown = (text) => {
                if (typeof marked !== 'undefined') {
                    console.log('%cüìù Rendering markdown...', 'color: #9b59b6; font-style: italic;');
                    return marked.parse(text);
                } else {
                    console.warn('‚ö†Ô∏è Marked.js not available, using plain text');
                    return text;
                }
            };

            let html = '<div class="markdown-content">';

            // Quest section with markdown
            html += '<h3>üó∫Ô∏è Your Quest</h3>';
            const questHtml = renderMarkdown(quest);
            html += questHtml;
            console.log('‚úÖ Quest rendered with markdown');
            console.log('  Quest length:', quest.length, 'chars');
            console.log('  Rendered HTML length:', questHtml.length, 'chars');

            html += '<hr style="margin: 20px 0;">';
            html += '<h3>üë• Your Party</h3>';

            // Characters section - Enhanced character cards
            if (data.characters && data.characters.length > 0) {
                html += '<h3 style="color: #FFD700; margin: 20px 0 15px 0;">üë• Your Party</h3>';
                data.characters.forEach(char => {
                    const charClass = char.class || char.char_class || 'Unknown Class';
                    const charHTML = `
                        <div class="character-card" style="display: flex; gap: 20px; padding: 20px; margin: 15px 0; background: linear-gradient(135deg, #2c1810 0%, #1a0f08 100%); border: 3px solid #8B4513; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.4);">
                            <div style="flex-shrink: 0; position: relative; width: 150px; height: 150px;">
                                <div id="spinner-${char.name}" class="portrait-spinner"></div>
                                <img id="portrait-${char.name}" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
                                     style="width: 150px; height: 150px; border: 4px solid #FFD700; border-radius: 12px; background: #333; object-fit: cover; opacity: 0;"
                                     onerror="this.style.display='none'"
                                     alt="${char.name} portrait">
                </div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 12px 0; color: #FFD700; font-size: 26px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">‚öîÔ∏è ${char.name}</h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 12px 0; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <div><strong style="color: #FFA500;">Class:</strong> <span style="color: #fff; font-size: 16px;">${charClass}</span></div>
                                    <div><strong style="color: #FF6B6B;">HP:</strong> <span style="color: #fff; font-size: 16px;">${char.hp}/${char.max_hp}</span></div>
                                    <div><strong style="color: #4ECDC4;">Attack:</strong> <span style="color: #fff; font-size: 16px;">${char.attack}</span></div>
                                    <div><strong style="color: #95E1D3;">Defense:</strong> <span style="color: #fff; font-size: 16px;">${char.defense}</span></div>
                </div>
                                <p style="margin: 12px 0; color: #DDD; font-style: italic; line-height: 1.6; font-size: 15px;">${char.intro || 'A brave adventurer ready to face any challenge that lies ahead.'}</p>
                                <div style="margin-top: 12px; padding: 10px; background: rgba(155, 89, 182, 0.2); border-left: 4px solid #9B59B6; border-radius: 4px;">
                                    <strong style="color: #9B59B6;">‚ö° Abilities:</strong>
                                    <span style="color: #E8B4F1; font-size: 15px;">${char.abilities.join(' ‚Ä¢ ')}</span>
                        </div>
                    </div>
                        </div>
                    `;
                    html += charHTML;
                    console.log(`‚úÖ Character HTML added: ${char.name} - ${charClass}`);

                    // Auto-generate character portrait
                    setTimeout(() => generateCharacterPortrait(char.name, charClass), 1000);
                });
            }

            // Scene section with markdown
            if (scene) {
                html += '<hr style="margin: 20px 0;">';
                html += '<h3>üìñ Current Scene</h3>';
                const narrative = scene.narrative || 'No scene description available';
                const sceneHtml = renderMarkdown(narrative);
                html += sceneHtml;
                console.log('‚úÖ Scene rendered with markdown');
                console.log('  Narrative length:', narrative.length, 'chars');
                console.log('  Rendered HTML length:', sceneHtml.length, 'chars');
            }

            html += '</div>';

            storyDiv.innerHTML = html;
            console.log('‚úÖ HTML injected into DOM');
            console.log('  Final HTML size:', html.length, 'chars');
            console.groupEnd();
            console.log('');

            console.log('%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó', 'color: #2ecc71; font-weight: bold; font-size: 14px;');
            console.log('%c‚ïë  ‚ú®  STORY RENDERING COMPLETE!                              ‚ïë', 'color: #2ecc71; font-weight: bold; font-size: 14px;');
            console.log('%c‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù', 'color: #2ecc71; font-weight: bold; font-size: 14px;');
            console.log('');

            // Auto-generate scene artwork after a brief delay
            if (scene) {
                console.log('%cüé® Auto-generating scene artwork...', 'color: #9B59B6; font-weight: bold;');
                setTimeout(() => {
                    const sceneDescription = scene.narrative || scene.location || 'fantasy adventure scene';
                    generateSceneImage(sceneDescription.substring(0, 200)); // Use first 200 chars as prompt
                }, 2000); // Wait 2 seconds after character portraits start
            }
        }

        async function nextScene() {
            console.log('‚ñ∂Ô∏è Getting next scene...');

            if (!sessionId) {
                console.error('No session ID');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/next-scene`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        player_action: 'continue'
                    })
                });

                    const data = await response.json();
                console.log('‚úÖ Next scene:', data);

                const storyDiv = document.getElementById('story-display');
                storyDiv.innerHTML += `<hr style="margin: 20px 0;"><p>${data.narrative}</p>`;

            } catch (error) {
                console.error('‚ùå Error getting next scene:', error);
            }
        }

        async function generateCharacterPortrait(charName, charClass) {
            console.log(`%cüé® Generating portrait for ${charName} (${charClass})...`, 'color: #9B59B6; font-weight: bold;');

            try {
                const prompt = `fantasy RPG character portrait, ${charClass} class, heroic pose, detailed face, D&D style`;

                const response = await fetch('http://localhost:5000/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        aspect_ratio: "1:1"  // Square portrait
                    })
                });

                    const data = await response.json();

                if (data.success && data.image) {
                    const portraitImg = document.getElementById(`portrait-${charName}`);
                    const spinner = document.getElementById(`spinner-${charName}`);

                    if (portraitImg) {
                        portraitImg.src = `data:image/png;base64,${data.image}`;
                        portraitImg.style.opacity = '1';
                        if (spinner) spinner.style.display = 'none';
                        console.log(`‚úÖ Portrait generated for ${charName}`);
                    }
                }
            } catch (error) {
                console.log(`‚ö†Ô∏è Portrait generation failed for ${charName} (using placeholder)`);
                const spinner = document.getElementById(`spinner-${charName}`);
                if (spinner) spinner.style.display = 'none';
            }
        }

        async function generateSceneImage() {
            console.log('%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó', 'color: #7B3F00; font-weight: bold; font-size: 14px;');
            console.log('%c‚ïë  üé®  GENERATING MULTI-IMAGE GALLERY                         ‚ïë', 'color: #7B3F00; font-weight: bold; font-size: 14px;');
            console.log('%c‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù', 'color: #7B3F00; font-weight: bold; font-size: 14px;');
            console.log('');
            console.log('üñºÔ∏è  Will generate 3 images:');
            console.log('   1Ô∏è‚É£  Pixel Art (PixelLab 64x64)');
            console.log('   2Ô∏è‚É£  Landscape (Nano Banana 16:9)');
            console.log('   3Ô∏è‚É£  Enhanced Pipeline (Sprite ‚Üí Nano Banana)');
            console.log('');

            if (!sessionId) {
                console.error('‚ùå No session ID - cannot generate images');
                alert('Please start an adventure first!');
                return;
            }

            // Show container
            const container = document.getElementById('scene-image-container');
            container.classList.remove('hidden');

            const sceneDesc = "epic fantasy tavern scene, medieval adventure";

            // Helper: Generate PixelLab Sprite
            const generateSprite = async () => {
                console.log('üéÆ [1/3] Generating PixelLab sprite...');
                const spinner = document.getElementById('sprite-loading');
                const img = document.getElementById('sprite-image');
                try {
                    const response = await fetch('http://localhost:5001/generate-sprite', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: sceneDesc, width: 64, height: 64 }),
                        signal: AbortSignal.timeout(30000)
                    });
                    const data = await response.json();
                    if (data.image) {
                        img.src = `data:image/png;base64,${data.image}`;
                        img.style.display = 'block';
                        spinner.style.display = 'none';
                        console.log('‚úÖ Sprite complete!');
                        return data.image;
                    }
                } catch (error) {
                    console.error('‚ùå Sprite failed:', error.message);
                    spinner.style.display = 'none';
                }
                return null;
            };

            // Helper: Generate Nano Banana Landscape
            const generateLandscape = async () => {
                console.log('üé® [2/3] Generating Nano Banana landscape...');
                const spinner = document.getElementById('landscape-loading');
                const img = document.getElementById('landscape-image');
                try {
                    const response = await fetch('http://localhost:5000/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: sceneDesc, aspect_ratio: "16:9" }),
                        signal: AbortSignal.timeout(30000)
                    });
                    const data = await response.json();
                    if (data.image) {
                        img.src = `data:image/png;base64,${data.image}`;
                        img.style.display = 'block';
                        spinner.style.display = 'none';
                        console.log('‚úÖ Landscape complete!');
                    }
                } catch (error) {
                    console.error('‚ùå Landscape failed:', error.message);
                    spinner.style.display = 'none';
                }
            };

            // Helper: Enhanced Pipeline
            const generateEnhanced = async (spriteData) => {
                console.log('‚ú® [3/3] Running enhancement pipeline...');
                const spinner = document.getElementById('enhanced-loading');
                const img = document.getElementById('enhanced-image');
                const status = document.getElementById('enhanced-status');
                if (!spriteData) {
                    status.textContent = '‚ö†Ô∏è Sprite not available';
                    spinner.style.display = 'none';
                    return;
                }
                status.textContent = 'üì§ Enhancing sprite with Nano Banana...';
                try {
                    const response = await fetch('http://localhost:5000/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: `Enhance: ${sceneDesc}`, aspect_ratio: "16:9" }),
                        signal: AbortSignal.timeout(30000)
                    });
                    const data = await response.json();
                    if (data.image) {
                        img.src = `data:image/png;base64,${data.image}`;
                        img.style.display = 'block';
                        spinner.style.display = 'none';
                        status.textContent = '‚úÖ Enhanced artwork complete!';
                        console.log('‚úÖ Enhanced complete!');
                    }
                } catch (error) {
                    console.error('‚ùå Enhancement failed:', error.message);
                    spinner.style.display = 'none';
                    status.textContent = '‚ùå Enhancement failed';
                }
            };

            // Execute: Sprite first, then parallel
            const spriteData = await generateSprite();
            await Promise.all([generateLandscape(), generateEnhanced(spriteData)]);
            console.log('üéâ All images generated!');
        }

        async function downloadAsPDF() {
            console.log('%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó', 'color: #654321; font-weight: bold; font-size: 14px;');
            console.log('%c‚ïë  üìÑ  GENERATING PDF EXPORT                                  ‚ïë', 'color: #654321; font-weight: bold; font-size: 14px;');
            console.log('%c‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù', 'color: #654321; font-weight: bold; font-size: 14px;');
            console.log('');

            try {
                console.log('üìÑ Initializing PDF generation...');
                console.log('jsPDF available:', typeof jspdf !== 'undefined' ? '‚úÖ YES' : '‚ùå NO');
                console.log('html2canvas available:', typeof html2canvas !== 'undefined' ? '‚úÖ YES' : '‚ùå NO');

                const startTime = performance.now();

                // Get the story content
                const storyScreen = document.getElementById('story-screen');

                console.log('üé® Capturing page content with html2canvas...');
                const canvas = await html2canvas(storyScreen, {
                    backgroundColor: '#F5DEB3',
                    scale: 2,
                    logging: false
                });

                const captureTime = (performance.now() - startTime).toFixed(2);
                console.log(`‚úÖ Canvas captured in ${captureTime}ms`);
                console.log('Canvas size:', canvas.width, 'x', canvas.height);

                // Create PDF
                console.log('üìù Creating PDF document...');
                const { jsPDF } = jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Add the canvas as an image
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                console.log('Adding image to PDF...');
                console.log('  Image dimensions:', imgWidth, 'x', imgHeight, 'mm');

                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

                // Generate filename with timestamp
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `narrative-theater-${timestamp}.pdf`;

                console.log('üíæ Saving PDF as:', filename);
                pdf.save(filename);

                const totalTime = (performance.now() - startTime).toFixed(2);
                console.log('');
                console.log('%c‚úÖ PDF EXPORT SUCCESSFUL!', 'color: #2ecc71; font-size: 16px; font-weight: bold;');
                console.log(`Total time: ${totalTime}ms`);
                console.log('Filename:', filename);
                console.log('');

            } catch (error) {
                console.error('%c‚ùå PDF EXPORT FAILED!', 'color: #e74c3c; font-weight: bold;');
                console.error('Error:', error.message);
                console.error('Full error:', error);
                alert('PDF generation failed: ' + error.message);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('%c' + '‚îÄ'.repeat(80), 'color: #95a5a6;');
            console.log('');
            console.log('%cüé¨ DOM CONTENT LOADED EVENT FIRED', 'color: #9b59b6; font-size: 16px; font-weight: bold;');
            console.log('');

            console.group('üîç DOM Element Check');
            const elements = {
                'start-screen': document.getElementById('start-screen'),
                'story-screen': document.getElementById('story-screen'),
                'characterName': document.getElementById('characterName'),
                'modelSelect': document.getElementById('modelSelect'),
                'start-status': document.getElementById('start-status')
            };

            for (const [id, element] of Object.entries(elements)) {
                console.log(`${element ? '‚úÖ' : '‚ùå'} #${id}:`, element ? 'Found' : 'Missing');
            }
            console.groupEnd();
            console.log('');

            console.log('%cüîå Initiating backend connection test...', 'color: #3498db; font-weight: bold;');
            console.log('');

            const connected = await testBackend();

            if (connected) {
                console.log('%cüéâ System fully initialized and ready for adventures!', 'color: #2ecc71; font-size: 14px; font-weight: bold;');
            } else {
                console.log('%c‚ö†Ô∏è System initialized but backend is offline', 'color: #e67e22; font-size: 14px; font-weight: bold;');
            }

            console.log('');
            console.log('%c' + '‚ïê'.repeat(80), 'color: #95a5a6;');
            console.log('%cüé≠ READY FOR ADVENTURES! Check out the console as you play! üé≤', 'color: #ff6b35; font-size: 16px; font-weight: bold; text-align: center;');
            console.log('%c' + '‚ïê'.repeat(80), 'color: #95a5a6;');
            console.log('');
        });

        console.log('');
        console.log('%c‚úÖ Script Parsing Complete', 'color: #2ecc71; font-weight: bold;');
        console.log('%c‚è≥ Waiting for DOM to load...', 'color: #f39c12; font-style: italic;');
        console.log('');
    </script>
</body>
</html>
