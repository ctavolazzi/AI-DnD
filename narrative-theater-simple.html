<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ The Narrative Theater üé≤ - Simple Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(90deg, #8B4513 0%, #A0522D 50%, #8B4513 100%);
            color: #2c1810;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 25px;
            background: linear-gradient(180deg, #d2691e 0%, #8B4513 100%);
            border: 4px solid #3e2723;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 42px;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
        }

        .subtitle {
            color: #ffecb3;
            font-size: 16px;
            margin-top: 10px;
        }

        .start-screen {
            text-align: center;
            padding: 60px 20px;
            background: rgba(210, 105, 30, 0.3);
            border: 3px solid #3e2723;
            border-radius: 8px;
        }

        .start-screen h2 {
            font-size: 32px;
            color: #3e2723;
            margin-bottom: 20px;
        }

        .start-screen p {
            font-size: 18px;
            color: #5d4037;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .controls {
            background: rgba(255,236,179,0.6);
            border: 2px solid #8B4513;
            border-radius: 6px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #3e2723;
        }

        select, input {
            width: 100%;
            padding: 10px;
            border: 2px solid #8B4513;
            border-radius: 4px;
            background: white;
            font-size: 16px;
            margin-bottom: 15px;
        }

        button {
            background: #8B4513;
            color: #ffd700;
            border: 2px solid #3e2723;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-weight: bold;
            width: 100%;
        }

        button:hover {
            background: #A0522D;
            transform: scale(1.02);
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border: 2px solid #3e2723;
            border-radius: 6px;
            text-align: left;
        }

        .hidden {
            display: none;
        }

        .story-content {
            background: rgba(255,236,179,0.6);
            border: 2px solid #8B4513;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé≠ THE NARRATIVE THEATER üé≤</h1>
            <div class="subtitle">Where Stories Come Alive ‚Ä¢ AI-Powered D&D Adventures</div>
        </div>

        <div id="start-screen" class="start-screen">
            <h2>Welcome, Adventurer!</h2>
            <p>
                Embark on an epic journey where narrative and imagery merge.<br>
                Your choices shape the story, and every moment can be visualized.<br>
                The theater awaits...
            </p>

            <div class="controls">
                <label for="modelSelect">ü§ñ AI Model:</label>
                <select id="modelSelect">
                    <option value="gemini">Gemini 2.5 Flash (Recommended)</option>
                    <option value="ollama">Ollama (Local)</option>
                </select>

                <label for="characterName">‚öîÔ∏è Your Character Name:</label>
                <input type="text" id="characterName" placeholder="Enter your hero's name..." value="Thorin">

                <button onclick="startAdventure()">üé≤ Start Your Adventure</button>
            </div>

            <div id="start-status" class="status hidden">
                <h3>Status:</h3>
                <div id="status-content">Ready to begin...</div>
            </div>
        </div>

        <div id="story-screen" class="story-content hidden">
            <h2>üìñ Your Adventure</h2>
            <div id="story-display">
                <p>Loading your adventure...</p>
            </div>
            <button onclick="nextScene()">‚ñ∂Ô∏è Continue</button>
        </div>
    </div>

    <script>
        console.log('üöÄ Simple Narrative Theater Loading...');

        // Backend configuration
        const BACKEND_URL = 'http://localhost:5002';
        let sessionId = null;

        // Test backend connection on load
        async function testBackend() {
            console.log('Testing backend connection...');
            try {
                const response = await fetch(`${BACKEND_URL}/health`);
                const data = await response.json();
                console.log('‚úÖ Backend connected:', data);
                return true;
            } catch (error) {
                console.error('‚ùå Backend error:', error);
                showStatus('‚ö†Ô∏è Backend not connected. Make sure server is running on port 5002.', 'error');
                return false;
            }
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('start-status');
            const statusContent = document.getElementById('status-content');
            statusDiv.classList.remove('hidden');
            statusContent.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;
            console.log(`[${type}] ${message}`);
        }

        async function startAdventure() {
            console.log('üé≤ Starting adventure...');

            const model = document.getElementById('modelSelect').value;
            const characterName = document.getElementById('characterName').value;

            if (!characterName.trim()) {
                showStatus('Please enter a character name!', 'error');
                return;
            }

            showStatus('Connecting to narrative server...', 'info');

            try {
                const response = await fetch(`${BACKEND_URL}/start-adventure`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model,
                        character_name: characterName
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                console.log('‚úÖ Adventure started:', data);

                sessionId = data.session_id;

                // Show the story
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('story-screen').classList.remove('hidden');

                displayStory(data);

            } catch (error) {
                console.error('‚ùå Error starting adventure:', error);
                showStatus(`Failed to start adventure: ${error.message}`, 'error');
            }
        }

        function displayStory(data) {
            const storyDiv = document.getElementById('story-display');
            let html = '<h3>üó∫Ô∏è Your Quest</h3>';
            html += `<p><strong>${data.quest || data.quest_description || 'No quest available'}</strong></p>`;
            html += '<hr style="margin: 20px 0;">';
            html += '<h3>üë• Your Party</h3>';

            if (data.characters && data.characters.length > 0) {
                data.characters.forEach(char => {
                    html += `<p>‚öîÔ∏è <strong>${char.name}</strong> - ${char.class || char.char_class || 'Adventurer'} (HP: ${char.hp}/${char.max_hp})</p>`;
                });
            }

            if (data.first_scene || data.current_scene) {
                html += '<hr style="margin: 20px 0;">';
                html += '<h3>üìñ Current Scene</h3>';
                const scene = data.first_scene || data.current_scene;
                html += `<p>${scene.narrative}</p>`;
            }

            storyDiv.innerHTML = html;
        }

        async function nextScene() {
            console.log('‚ñ∂Ô∏è Getting next scene...');

            if (!sessionId) {
                console.error('No session ID');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/next-scene`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        player_action: 'continue'
                    })
                });

                const data = await response.json();
                console.log('‚úÖ Next scene:', data);

                const storyDiv = document.getElementById('story-display');
                storyDiv.innerHTML += `<hr style="margin: 20px 0;"><p>${data.narrative}</p>`;

            } catch (error) {
                console.error('‚ùå Error getting next scene:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOM loaded, testing backend...');
            testBackend();
        });

        console.log('‚úÖ Script loaded successfully');
    </script>
</body>
</html>
